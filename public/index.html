<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimal-ui"
    />
    <title>ZAHotMap</title>
    <!-- Google Fonts -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic"
    />
    <!-- CSS Reset -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css"
    />
    <!-- Milligram CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css"
    />
    <link rel="stylesheet" href="main.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin=""
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="main.js"></script>
    <script>
      var heatmapLayer,
        lat = -26.1069,
        lng = 28.104,
        zoom = 10;

      function createMap() {
        const baseLayer = L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            attribution:
              'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a>',
          }
        );
        const cfg = {
          radius: 20,
          scaleRadius: false,
          useLocalExtrema: false,
          valueField: "temp",
        };
        heatmapLayer = new HeatmapOverlay(cfg);

        const leafletMap = new L.Map("map", {
          center: new L.LatLng(lat, lng),
          zoom: zoom,
          layers: [baseLayer, heatmapLayer],
        });

        leafletMap.on("click", function (e) {
	      const obs = document.querySelector("#obs").value;
          window.location.href = `/listing.html?lat=${e.latlng.lat}&lng=${e.latlng.lng}&obs=${obs}&radius-km=0.2`;
        });
      }

      async function loadHotSpotData() {
        const obs = document.querySelector("#obs").value;
        const period = document.querySelector("#period").value;

        const resp = await axios.get(
          `/hot-spots?lat=${lat}&lng=${lng}&obs=${obs}&period=${period}`
        );

        heatmapLayer.setData({
          data: resp.data,
          min: 0,
          max: 1,
        });
      }
    </script>
  </head>
  <body>
    <main class="wrapper">
      <nav class="navigation">
        <section class="container">
          <ul class="navigation-list float-right">
            <li class="navigation-item">
              <a class="navigation-link" href="/">Live map</a>
            </li>
            <li class="navigation-item">
              <a class="navigation-link" href="/listing.html">Nearby reports</a>
            </li>
            <li class="navigation-item">
              <a class="navigation-link" href="/new.html">New report</a>
            </li>
          </ul>
        </section>
      </nav>
      <section id="docs" class="container">
        <h4>ðŸ‡¿ðŸ‡¦ Heat maps by the people</h4>
        <p>
          Heat maps built with data from our mobile devices. The map temperature
          reflects the number of recent reports in an area. Click on the map to
          see a listing of reports near that point.
          <b>Your reports power this app</b>, use the menu above to send a
          report whenever you make one of the observations below.
        </p>
        <label for="obs">Show hot spots of</label>
        <select id="obs" name="obs" required onchange="loadHotSpotData()">
          <option selected value="covid_vac">
            COVID-19 vaccination for walk-ins
          </option>
          <option value="supplies">
            supplies like food, water or blankets
          </option>
          <option value="crime">suspicious or criminal activity</option>
          <option value="dumping">
            illegal dumping, litter or eco hazards
          </option>
          <option value="fire">uncontrolled fire</option>
          <option value="flooding">flooding</option>
          <option value="protest">protest or civil unrest</option>
          <option value="road">impassable roads</option>
        </select>
        <label for="period">halving in temperature every</label>
        <select id="period" name="period" required onchange="loadHotSpotData()">
          <option value="1">1 hour (hides older reports)</option>
          <option value="4">4 hours</option>
          <option value="24">24 hours</option>
          <option selected value="720">30 days (reveals older reports)</option>
        </select>
        <div id="map"></div>
        <script
          src="https://cdn.jsdelivr.net/npm/heatmapjs@2.0.2/heatmap.min.js"
          integrity="sha256-9waIqGPUnXpt9C3BvXatjTzAfsP5svrnzFYa9Lmf0zU="
          crossorigin="anonymous"
        ></script>
        <script src="https://cdn.jsdelivr.net/npm/leaflet-heatmap@1.0.0/leaflet-heatmap.min.js"></script>
        <script>
          window.onload = async function () {
            const urlParams = new URLSearchParams(window.location.search);

            for (const [key, value] of urlParams) {
              field = document.querySelector(`#${key}`);
              if (field) field.value = value;
            }

            try {
              if (!urlParams.has("lat")) {
                const position = await getPosition();
                lat = position.coords.latitude;
                lng = position.coords.longitude;
              } else {
                lat = urlParams.get("lat");
                lng = urlParams.get("lng");
                zoom = 16;
              }
            } catch (err) {
              console.log("Location not found, using default map centre.");
            } finally {
              createMap();
              loadHotSpotData();
            }
          };
        </script>
      </section>
    </main>
  </body>
</html>
